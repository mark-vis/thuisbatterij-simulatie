<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulatie met PV - Thuisbatterij Simulatie</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <nav>
        <div class="nav-container">
            <h1>‚ö° Thuisbatterij Simulatie</h1>
            <div class="nav-links">
                <a href="index.html">Simulatie</a>
                <a href="with_solar.html" class="active">Met PV</a>
                <a href="advanced.html">Geavanceerd</a>
                <a href="custom_data.html">Eigen Data</a>
                <a href="technical.html">Technisch</a>
                <a href="about.html">Over</a>
                <a href="legal.html">Disclaimer</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <section class="intro">
            <h2>Simulatie met PV-opwek en Verbruik</h2>
            <p>Simuleer de besparing van een batterij in combinatie met zonnepanelen. Vergelijk dynamische prijzen met en zonder batterij tegen een vast contract.</p>
        </section>

        <div class="layout-two-column">
        <section class="simulation-form">
            <form id="solarSimulationForm">
                <div class="form-section">
                    <h3>Dataselectie</h3>
                    <div class="form-group-inline">
                        <label for="year">Jaar:</label>
                        <select id="year" name="year" required>
                            <option value="2024" selected>2024</option>
                        </select>
                    </div>
                    <div class="form-group-inline">
                        <label for="consumptionProfile">Verbruiksprofiel:</label>
                        <select id="consumptionProfile" name="consumptionProfile" required>
                            <option value="basis" selected>Basis (~3.5 MWh/jaar)</option>
                            <option value="wp">WP (~6.5 MWh/jaar)</option>
                            <option value="ev">EV (~6.5 MWh/jaar)</option>
                            <option value="wp_ev">WP + EV (~9.5 MWh/jaar)</option>
                        </select>
                    </div>
                    <div class="form-group-inline">
                        <label for="solarProfile">PV Systeem:</label>
                        <select id="solarProfile" name="solarProfile" required>
                            <option value="0kwp">Geen PV (0 kWp)</option>
                            <option value="1kwp">1 kWp (~1.0 MWh/jaar)</option>
                            <option value="2kwp">2 kWp (~2.1 MWh/jaar)</option>
                            <option value="3kwp">3 kWp (~3.1 MWh/jaar)</option>
                            <option value="4kwp">4 kWp (~4.1 MWh/jaar)</option>
                            <option value="5kwp" selected>5 kWp (~5.2 MWh/jaar)</option>
                            <option value="6kwp">6 kWp (~6.2 MWh/jaar)</option>
                            <option value="7kwp">7 kWp (~7.3 MWh/jaar)</option>
                            <option value="8kwp">8 kWp (~8.3 MWh/jaar)</option>
                            <option value="9kwp">9 kWp (~9.4 MWh/jaar)</option>
                            <option value="10kwp">10 kWp (~10.4 MWh/jaar)</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Batterijconfiguratie</h3>
                    <div class="form-group-inline">
                        <label for="capacity">Capaciteit (kWh):</label>
                        <input type="number" id="capacity" name="capacity" min="1" max="200" step="0.1" value="32" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="initialSoc">Initi√´le SoC (%):</label>
                        <input type="number" id="initialSoc" name="initialSoc" min="0" max="100" step="1" value="50" required>
                    </div>

                    <div class="form-group-inline">
                        <label for="chargePower">Laadvermogen DC (kW):</label>
                        <input type="number" id="chargePower" name="chargePower" min="0.1" max="50" step="0.1" value="8.0" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="dischargePower">Ontlaadvermogen DC (kW):</label>
                        <input type="number" id="dischargePower" name="dischargePower" min="0.1" max="50" step="0.1" value="8.0" required>
                    </div>

                    <div class="form-group-inline">
                        <label for="chargeEff">Laadeffici√´ntie (%):</label>
                        <input type="number" id="chargeEff" name="chargeEff" min="50" max="100" step="0.1" value="89" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="dischargeEff">Ontlaadeffici√´ntie (%):</label>
                        <input type="number" id="dischargeEff" name="dischargeEff" min="50" max="100" step="0.1" value="89" required>
                    </div>

                    <div class="form-group-inline">
                        <label for="minSoc">Min SoC (%):</label>
                        <input type="number" id="minSoc" name="minSoc" min="0" max="100" step="1" value="10" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="maxSoc">Max SoC (%):</label>
                        <input type="number" id="maxSoc" name="maxSoc" min="0" max="100" step="1" value="100" required>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Dynamische Prijzen</h3>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="priceMode" value="standard-saldering">
                            Standaard met salderen (Tibber 2025)
                        </label>
                        <small class="formula-display">
                            Inkoop: (EPEX + ‚Ç¨0,10154) √ó 1,21 + ‚Ç¨0,0248<br>
                            Teruglevering: (EPEX + ‚Ç¨0,10154) √ó 1,21 + ‚Ç¨0,0248<br>
                            (EPEX in EUR/kWh)
                        </small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="priceMode" value="standard-no-saldering" checked>
                            Standaard zonder salderen (Tibber 2025)
                        </label>
                        <small class="formula-display">
                            Inkoop: (EPEX + ‚Ç¨0,10154) √ó 1,21 + ‚Ç¨0,0248<br>
                            Teruglevering: EPEX + ‚Ç¨0,0248/1,21<br>
                            (EPEX in EUR/kWh)
                        </small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="priceMode" value="bare">
                            Kaal (EPEX zonder BTW)
                        </label>
                        <small class="formula-display">
                            Inkoop: EPEX<br>
                            Teruglevering: EPEX<br>
                            (EPEX in EUR/kWh)
                        </small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="priceMode" value="custom">
                            Geavanceerd (eigen formules)
                        </label>
                    </div>
                    <div id="customFormulaInputs" style="display: none; margin-top: 1rem;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customBuyFormula">Inkoop formule (JavaScript):</label>
                                <input type="text" id="customBuyFormula" placeholder="epex => (epex + 0.10154) * 1.21 + 0.0248">
                                <small>Variabele: epex (EUR/kWh), resultaat: EUR/kWh</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customSellFormula">Teruglevering formule (JavaScript):</label>
                                <input type="text" id="customSellFormula" placeholder="epex => (epex + 0.10154) * 1.21 + 0.0248">
                                <small>Variabele: epex (EUR/kWh), resultaat: EUR/kWh</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Vast Contract (referentie)</h3>
                    <div class="form-group-inline">
                        <label for="fixedBuyPrice">Inkoop (‚Ç¨/kWh):</label>
                        <input type="number" id="fixedBuyPrice" name="fixedBuyPrice" min="0" max="1" step="0.001" value="0.23" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="fixedSellPrice">Teruglevering (‚Ç¨/kWh):</label>
                        <input type="number" id="fixedSellPrice" name="fixedSellPrice" min="-0.10" max="1" step="0.001" value="0.02" required>
                        <small id="negativePriceWarning" style="display: none; color: var(--warning-color); margin-top: 0.5rem;">
                            üòè zit jij bij innova biatch?
                        </small>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" id="runButton">üöÄ Start Simulatie</button>
                </div>
            </form>

            <div id="progress" class="progress-container" style="display: none;">
                <div class="progress-bar">
                    <div id="progressBar" class="progress-fill"></div>
                </div>
                <p id="progressText">Bezig met simuleren...</p>
            </div>
        </section>

        <section id="results" class="results-section" style="display: none;">
            <h2>Simulatie Resultaten</h2>

            <div class="totals-summary">
                <div class="total-card">
                    <h3>Zelfverbruik</h3>
                    <p class="total-value" id="selfConsumption">0%</p>
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">PV naar verbruik of batterij</small>
                </div>
                <div class="total-card">
                    <h3>Zelfvoorziening</h3>
                    <p class="total-value" id="selfSufficiency">0%</p>
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">Verbruik uit PV of batterij</small>
                </div>
                <div class="total-card">
                    <h3>Besparing Totaal</h3>
                    <p class="total-value profit" id="totalSavings">‚Ç¨0.00</p>
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">vast ‚Üí dynamisch + batterij</small>
                </div>
            </div>

            <div class="totals-summary">
                <div class="total-card">
                    <h3>Totale Cycli</h3>
                    <p class="total-value" id="totalCycles">0</p>
                </div>
                <div class="total-card">
                    <h3>Besparing per cyclus</h3>
                    <p class="total-value" id="savingsPerCycle">‚Ç¨0.00</p>
                </div>
                <div class="total-card">
                    <h3>Grid Import</h3>
                    <p class="total-value" id="gridImport" style="font-size: 1.2rem;">0 kWh</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;" id="gridImportComparison">zonder bat: 0 kWh</small>
                </div>
                <div class="total-card">
                    <h3>Grid Export</h3>
                    <p class="total-value" id="gridExport" style="font-size: 1.2rem;">0 kWh</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;" id="gridExportComparison">zonder bat: 0 kWh</small>
                </div>
            </div>

            <div class="totals-summary">
                <div class="total-card">
                    <h3>Gem. Inkoopprijs</h3>
                    <p class="total-value" id="avgBuyPrice" style="font-size: 1.2rem;">‚Ç¨0.000/kWh</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;" id="avgBuyPriceComparison">zonder bat: ‚Ç¨0.000</small>
                </div>
                <div class="total-card">
                    <h3>Gem. Verkoopprijs</h3>
                    <p class="total-value" id="avgSellPrice" style="font-size: 1.2rem;">‚Ç¨0.000/kWh</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;" id="avgSellPriceComparison">zonder bat: ‚Ç¨0.000</small>
                </div>
                <div class="total-card">
                    <h3>Export @ neg. prijs</h3>
                    <p class="total-value" id="exportAtNegPrice" style="font-size: 1.2rem;">0 kWh</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;" id="exportAtNegPriceComparison">zonder bat: 0 kWh</small>
                </div>
            </div>

            <div class="table-container">
                <h3>Scenariovergelijking</h3>
                <table id="scenariosTable">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Jaarkosten</th>
                            <th>Zelfverbruik</th>
                            <th>Zelfvoorziening</th>
                        </tr>
                    </thead>
                    <tbody id="scenariosTableBody">
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <h3>Besparingen in detail</h3>
                <table id="savingsTable">
                    <thead>
                        <tr>
                            <th>Vergelijking</th>
                            <th>Besparing</th>
                            <th>Toelichting</th>
                        </tr>
                    </thead>
                    <tbody id="savingsTableBody">
                    </tbody>
                </table>
            </div>

            <div class="charts-container">
                <div class="chart-box full-width">
                    <h3>Maandelijkse Kosten Vergelijking</h3>
                    <div style="height: 400px;">
                        <canvas id="costsComparisonChart"></canvas>
                    </div>
                </div>
                <div class="chart-box full-width">
                    <h3>Grid Flows per Maand</h3>
                    <div style="height: 400px;">
                        <canvas id="gridFlowsChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h3>Zelfverbruik per Maand</h3>
                    <div style="height: 400px;">
                        <canvas id="selfConsumptionChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h3>Zelfvoorziening per Maand</h3>
                    <div style="height: 400px;">
                        <canvas id="selfSufficiencyChart"></canvas>
                    </div>
                </div>
                <div class="chart-box full-width">
                    <h3>Energiestromen (met batterij)</h3>
                    <div style="height: 400px;">
                        <canvas id="energyFlowsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <h3>Maandelijks Overzicht (Met Batterij)</h3>
                <table id="monthlyTable">
                    <thead>
                        <tr>
                            <th>Maand</th>
                            <th>Kosten (‚Ç¨)</th>
                            <th>Besparing (‚Ç¨)</th>
                            <th>Verbruik (kWh)</th>
                            <th>PV Opwek (kWh)</th>
                            <th>Grid Import (kWh)</th>
                            <th>Grid Export (kWh)</th>
                            <th>Zelfverbruik (%)</th>
                            <th>Zelfvoorziening (%)</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyTableBody">
                    </tbody>
                </table>
            </div>

            <div class="form-actions" style="margin-top: 2rem;">
                <button type="button" id="shareUrlButton" class="btn-secondary">üîó Kopieer URL</button>
            </div>
        </section>

        <!-- Detail view (hidden by default) -->
        <section id="detailView" class="detail-view" style="display: none;">
            <div class="detail-header">
                <button id="closeDetail" class="btn-back">‚Üê Terug naar overzicht</button>
                <h3 id="detailTitle"></h3>

                <!-- Month navigation -->
                <div class="detail-nav" id="monthNavigation" style="display: none;">
                    <button id="prevMonth" class="btn-nav">‚Üê Vorige maand</button>
                    <button id="nextMonth" class="btn-nav">Volgende maand ‚Üí</button>
                </div>

                <!-- Day navigation -->
                <div class="detail-nav" id="dayNavigation" style="display: none;">
                    <button id="prevMonthDay" class="btn-nav">‚Üê‚Üê‚Üê Maand</button>
                    <button id="prevWeek" class="btn-nav">‚Üê‚Üê Week</button>
                    <button id="prevDay" class="btn-nav">‚Üê Vorige dag</button>
                    <button id="nextDay" class="btn-nav">Volgende dag ‚Üí</button>
                    <button id="nextWeek" class="btn-nav">Week ‚Üí‚Üí</button>
                    <button id="nextMonthDay" class="btn-nav">Maand ‚Üí‚Üí‚Üí</button>
                </div>
            </div>

            <!-- Daily table view -->
            <div id="dailyView" class="table-container" style="display: none;">
                <table id="dailyTable">
                    <thead>
                        <tr>
                            <th>Dag</th>
                            <th>Besparing (‚Ç¨)</th>
                            <th>Cycli</th>
                            <th>Grid Import (kWh)</th>
                            <th>Grid Export (kWh)</th>
                            <th>SoC Min-Max (%)</th>
                        </tr>
                    </thead>
                    <tbody id="dailyTableBody"></tbody>
                </table>
            </div>

            <!-- Timestep chart view -->
            <div id="timestepView" class="chart-box" style="display: none;">
                <div style="height: 500px;">
                    <canvas id="timestepChart"></canvas>
                </div>
            </div>
        </section>
        </div><!-- .layout-two-column -->
    </main>

    <footer>
        <p>&copy; Mark Vis | Met dank aan <a href="https://jeroen.nl/" target="_blank">jeroen.nl</a> voor historische prijsdata</p>
    </footer>

    <!-- Load JavaScript modules -->
    <!-- HiGHS MILP Solver -->
    <script src="js/lib/highs.js"></script>

    <script src="js/battery.js"></script>
    <script src="js/optimizer.js"></script>
    <script src="js/solar_simulator.js"></script>
    <script src="js/solar_ui.js"></script>
</body>
</html>
