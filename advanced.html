<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geavanceerde Analyses - Thuisbatterij Simulatie</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <nav>
        <div class="nav-container">
            <h1>âš¡ Thuisbatterij Simulatie</h1>
            <div class="nav-links">
                <a href="index.html">Simulatie</a>
                <a href="advanced.html" class="active">Geavanceerd</a>
                <a href="technical.html">Technisch</a>
                <a href="about.html">Over</a>
                <a href="legal.html">Disclaimer</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <section class="intro">
            <h2>Geavanceerde Analyses</h2>
            <p>Vind de optimale configuratie voor jouw batterij met power-afhankelijke efficiency curves.</p>
        </section>

        <div class="layout-two-column">
        <section class="simulation-form">
            <form id="sweepForm">
                <div class="form-section">
                    <div class="form-group-inline">
                        <label for="year">Jaar:</label>
                        <select id="year" name="year" required>
                            <option value="2024" selected>2024</option>
                            <option value="2025">2025 (t/m oktober)</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Batterij Configuratie</h3>
                    <div class="form-group-inline">
                        <label for="capacity">Capaciteit (kWh):</label>
                        <input type="number" id="capacity" name="capacity" min="1" max="100" step="0.1" value="32" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="initialSoc">InitiÃ«le SoC (%):</label>
                        <input type="number" id="initialSoc" name="initialSoc" min="0" max="100" step="1" value="50" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="minSoc">Min SoC (%):</label>
                        <input type="number" id="minSoc" name="minSoc" min="0" max="100" step="1" value="0" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="maxSoc">Max SoC (%):</label>
                        <input type="number" id="maxSoc" name="maxSoc" min="0" max="100" step="1" value="100" required>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Laadvermogen Sweep (DC)</h3>
                    <div class="form-group-inline">
                        <label for="chargePowerMin">Min (kW):</label>
                        <input type="number" id="chargePowerMin" name="chargePowerMin" min="0.1" max="11" step="0.1" value="2.0" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="chargePowerMax">Max (kW):</label>
                        <input type="number" id="chargePowerMax" name="chargePowerMax" min="0.1" max="11" step="0.1" value="11.0" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="chargePowerStep">Step (kW):</label>
                        <input type="number" id="chargePowerStep" name="chargePowerStep" min="0.1" max="5" step="0.1" value="1.0" required>
                    </div>
                    <small style="color: var(--text-secondary); margin-left: 220px;">Max: 11 kW DC (omvormer limiet)</small>
                </div>

                <div class="form-section">
                    <h3>Ontlaadvermogen Sweep (DC)</h3>
                    <div class="form-group-inline">
                        <label for="dischargePowerMin">Min (kW):</label>
                        <input type="number" id="dischargePowerMin" name="dischargePowerMin" min="0.1" max="17" step="0.1" value="2.0" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="dischargePowerMax">Max (kW):</label>
                        <input type="number" id="dischargePowerMax" name="dischargePowerMax" min="0.1" max="17" step="0.1" value="17.0" required>
                    </div>
                    <div class="form-group-inline">
                        <label for="dischargePowerStep">Step (kW):</label>
                        <input type="number" id="dischargePowerStep" name="dischargePowerStep" min="0.1" max="5" step="0.1" value="1.0" required>
                    </div>
                    <small style="color: var(--text-secondary); margin-left: 220px;">Max: 17 kW DC (omvormer limiet)</small>
                </div>

                <div class="form-section">
                    <h3>Efficiency Model</h3>
                    <p><strong>Victron MultiPlus 5000 (3-phase)</strong></p>
                    <div class="efficiency-preview" id="efficiencyPreview">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <div class="form-section">
                    <h3>Prijzen</h3>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="priceMode" value="standard-saldering" checked>
                            Standaard met salderen (Tibber 2025)
                        </label>
                        <small class="formula-display">
                            Inkoop: (EPEX + â‚¬0,10154) Ã— 1,21 + â‚¬0,0248<br>
                            Teruglevering: (EPEX + â‚¬0,10154) Ã— 1,21 + â‚¬0,0248<br>
                            (EPEX in EUR/kWh)
                        </small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="priceMode" value="standard-no-saldering">
                            Standaard zonder salderen (Tibber 2025)
                        </label>
                        <small class="formula-display">
                            Inkoop: (EPEX + â‚¬0,10154) Ã— 1,21 + â‚¬0,0248<br>
                            Teruglevering: EPEX + â‚¬0,0248/1,21<br>
                            (EPEX in EUR/kWh)
                        </small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="priceMode" value="bare">
                            Kaal (EPEX zonder BTW)
                        </label>
                        <small class="formula-display">
                            Inkoop: EPEX<br>
                            Teruglevering: EPEX<br>
                            (EPEX in EUR/kWh)
                        </small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="radio" name="priceMode" value="custom">
                            Geavanceerd (eigen formules)
                        </label>
                    </div>
                    <div id="customFormulaInputs" style="display: none; margin-top: 1rem;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customBuyFormula">Inkoop formule (JavaScript):</label>
                                <input type="text" id="customBuyFormula" name="customBuyFormula" placeholder="(epex / 1000 + 0.10154) * 1.21 + 0.0248">
                                <small>Variabele: epex (EUR/MWh), return EUR/kWh</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customSellFormula">Teruglevering formule (JavaScript):</label>
                                <input type="text" id="customSellFormula" name="customSellFormula" placeholder="(epex / 1000 + 0.10154) * 1.21 + 0.0248">
                                <small>Variabele: epex (EUR/MWh), return EUR/kWh</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit">ðŸš€ Start Power Sweep</button>
                </div>
            </form>

            <div id="progress" class="progress-container" style="display: none;">
                <div class="progress-bar">
                    <div id="progressBar" class="progress-fill"></div>
                </div>
                <p id="progressText">Bezig met sweep...</p>
            </div>
        </section>

        <section id="results" class="results-section" style="display: none;">
            <h2>Power Sweep Resultaten</h2>

            <div class="totals-summary">
                <div class="total-card">
                    <h3>Beste Configuratie</h3>
                    <p class="total-value" id="bestConfigText" style="font-size: 1.2rem;">-</p>
                </div>
                <div class="total-card">
                    <h3>Totale Winst</h3>
                    <p class="total-value profit" id="totalProfit">â‚¬0.00</p>
                </div>
                <div class="total-card">
                    <h3>Totaal Cycles</h3>
                    <p class="total-value" id="totalCycles">0</p>
                </div>
                <div class="total-card">
                    <h3>Winst per Cycle</h3>
                    <p class="total-value" id="avgProfitPerCycle">â‚¬0.00</p>
                </div>
                <div class="total-card">
                    <h3>Efficiency</h3>
                    <p class="total-value" id="bestEfficiency" style="font-size: 1.2rem;">-</p>
                    <small>Laden / Ontladen</small>
                </div>
            </div>

            <div id="diagonalChartContainer" class="chart-box full-width" style="display: none; margin-bottom: 2rem;">
                <h3>Symmetrisch Vermogen (Diagonaal)</h3>
                <div style="height: 400px;">
                    <canvas id="diagonalChart"></canvas>
                </div>
            </div>

            <div id="heatmapContainer" class="chart-box full-width" style="margin-bottom: 2rem;">
                <h3>Volledig Grid (Heatmap)</h3>
                <!-- Filled by JavaScript -->
            </div>

            <div class="table-container">
                <h3>Top 10 Configuraties</h3>
                <table id="top10Table">
                    <thead>
                        <tr>
                            <th>Laden (kW)</th>
                            <th>Ontladen (kW)</th>
                            <th>Winst (â‚¬)</th>
                            <th>Cycles</th>
                            <th>â‚¬/Cycle</th>
                            <th>Eff Laden</th>
                            <th>Eff Ontladen</th>
                        </tr>
                    </thead>
                    <tbody id="top10TableBody">
                    </tbody>
                </table>
            </div>
        </section>
        </div><!-- .layout-two-column -->
    </main>

    <!-- Configuration Detail Modal -->
    <div id="configModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
                <button id="closeModal" class="btn-secondary">âœ• Sluiten</button>
            </div>
            <div id="modalContent">
                <!-- Filled by JavaScript -->
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; Mark Vis | Met dank aan <a href="https://jeroen.nl/" target="_blank">jeroen.nl</a> voor historische prijsdata</p>
    </footer>

    <!-- Load JavaScript modules -->
    <!-- HiGHS MILP Solver -->
    <script src="js/lib/highs.js"></script>

    <script src="js/battery.js"></script>
    <script src="js/optimizer.js"></script>
    <script src="js/simulator.js"></script>
    <script src="js/efficiency_curves.js"></script>
    <script src="js/power_sweep.js"></script>
    <script src="js/advanced_charts.js"></script>
    <script src="js/advanced_ui.js"></script>
</body>
</html>
